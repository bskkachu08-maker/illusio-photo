<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>+ILLuSio</title>
<style>
 body{
   margin:0; background:#f7f7f7; font-family:"Hiragino Sans",sans-serif; text-align:center;
 }
 header{position:relative; padding:10px 0;}
 .logo{font-size:2rem; font-weight:700;}
 .add-part{
   position:absolute; right:10px; top:10px; background:#111; color:#fff;
   border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:600;
 }
 .main-area{display:flex; justify-content:center; align-items:center; height:70vh;}
 svg{display:block;}
 footer{padding:10px;}
 .btn{background:#111; color:#fff; border:0; border-radius:10px; padding:10px 16px; cursor:pointer;}
 .parts-panel{
   position:fixed; left:0; right:0; bottom:-65%;
   background:#fff; border-top:2px solid #ddd; border-radius:16px 16px 0 0;
   transition:bottom .3s ease; padding:10px; box-shadow:0 -5px 15px rgba(0,0,0,.2);
   max-height:65%; overflow:auto;
 }
 .parts-panel.open{bottom:0;}
 .color-tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px;}
 .tab{border:1px solid #aaa; background:#fff; border-radius:999px; padding:5px 10px; cursor:pointer;}
 .tab.active{background:#111; color:#fff;}
 .parts-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin:10px;}
 .part-img{width:100%; aspect-ratio:1/1; object-fit:contain; border:1px solid #ccc; border-radius:10px; cursor:grab;}
 .edit-bar{
   position:fixed; right:16px; bottom:16px; background:#111; color:#fff;
   padding:14px; border-radius:16px; display:none; flex-direction:column; gap:10px;
 }
 .edit-bar.show{display:flex;}
 .edit-row{display:flex; gap:8px; justify-content:center;}
 .ctrl{
   width:46px; height:46px; border-radius:12px; border:1px solid rgba(255,255,255,.2);
   background:#111; color:#fff; font-size:18px; font-weight:700; cursor:pointer;
 }
 .ctrl:hover{background:#222;}
</style>
</head>
<body>
<header>
<h1 class="logo">+ILLuSio</h1>
<button id="addPartBtn" class="add-part">ï¼‹ãƒ‘ãƒ¼ãƒ„è¿½åŠ </button>
</header>
<main class="main-area">
<svg id="canvas" width="340" height="340">
<circle id="wire" cx="170" cy="170" r="140" stroke="#aaa" stroke-width="2" fill="none"/>
</svg>
</main>
<footer>
<button id="saveBtn" class="btn">ğŸ’ ä¿å­˜</button>
<button id="partsBtn" class="btn">ğŸ’  ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</button>
</footer>
<div id="partsPanel" class="parts-panel">
<div id="colorTabs" class="color-tabs"></div>
<div id="partsContent"></div>
</div>
<div id="editBar" class="edit-bar">
<div class="edit-row">
<button id="rotateL" class="ctrl">â†º</button>
<button id="rotateR" class="ctrl">â†»</button>
</div>
<div class="edit-row">
<button id="bigger" class="ctrl">ï¼‹</button>
<button id="smaller" class="ctrl">ï¼</button>
</div>
<div class="edit-row">
<button id="moveLeft" class="ctrl">â†</button>
<button id="moveRight" class="ctrl">â†’</button>
</div>
<button id="delete" class="ctrl">ğŸ—‘</button>
</div>
<script>
const svg = document.getElementById("canvas");
const wire = document.getElementById("wire");
const colorTabs = document.getElementById("colorTabs");
const partsContent = document.getElementById("partsContent");
const editBar = document.getElementById("editBar");
let beads = [];
let selected = null;
let rotationDeg = 0;
let activeColor = "èµ¤";
let photosCache = [];
const COLORS = ["èµ¤","ãƒ”ãƒ³ã‚¯","é’","ç·‘","ç™½","ç´«","ã‚¿ãƒ¼ã‚³ã‚¤ã‚º","é€æ˜","é‡‘è‰²","ã‚·ãƒ«ãƒãƒ¼","é»’","ãã®ä»–"];
const STEP = 6 * Math.PI/180;
const ZOOM = 1.5;
function getCircle(){return {cx:170, cy:170, r:140};}
function normalize(a){while(a<-Math.PI)a+=2*Math.PI;while(a>Math.PI)a-=2*Math.PI;return a;}
function angleAt(x,y){const {cx,cy}=getCircle();return Math.atan2(y-cy,x-cx);}
function pos(angle,w,h){const {cx,cy,r}=getCircle();return{x:cx+r*Math.cos(angle)-w/2,y:cy+r*Math.sin(angle)-h/2};}
function centerOf(el){const x=parseFloat(el.getAttribute("x")),y=parseFloat(el.getAttribute("y")),w=parseFloat(el.getAttribute("width")),h=parseFloat(el.getAttribute("height"));return{cx:x+w/2,cy:y+h/2,w,h};}
function applyRotate(el,deg){el.dataset.rotate=deg;const c=centerOf(el);el.setAttribute("transform",`rotate(${deg},${c.cx},${c.cy})`);}
function addBead(url,angle){
 const el=document.createElementNS("http://www.w3.org/2000/svg","image");
 el.setAttributeNS(null,"href",url);el.setAttribute("width",35);el.setAttribute("height",35);
 el.dataset.rotate="0";svg.appendChild(el);
 const bead={el,angle:normalize(angle)};beads.push(bead);
 const p=pos(bead.angle,35,35);el.setAttribute("x",p.x);el.setAttribute("y",p.y);
 el.addEventListener("pointerdown",e=>{
   e.preventDefault();select(el);
 });
 el.addEventListener("pointermove",e=>{
   if(e.buttons!==1)return;
   const rect=svg.getBoundingClientRect();
   const mx=e.clientX-rect.left,my=e.clientY-rect.top;
   const ang=angleAt(mx,my);
   bead.angle=normalize(ang);
   const w=parseFloat(el.getAttribute("width")),h=parseFloat(el.getAttribute("height"));
   const p=pos(bead.angle,w,h);
   el.setAttribute("x",p.x);el.setAttribute("y",p.y);
 });
 el.addEventListener("click",()=>select(el));
}
function select(el){selected=beads.find(b=>b.el===el)||null;if(selected){rotationDeg=parseFloat(el.dataset.rotate||"0");editBar.classList.add("show");}else editBar.classList.remove("show");}
svg.addEventListener("pointerdown",e=>{if(e.target.tagName!=="image"){selected=null;editBar.classList.remove("show");}});
document.getElementById("rotateL").onclick=()=>{if(!selected)return;rotationDeg-=15;applyRotate(selected.el,rotationDeg);};
document.getElementById("rotateR").onclick=()=>{if(!selected)return;rotationDeg+=15;applyRotate(selected.el,rotationDeg);};
document.getElementById("bigger").onclick=()=>{if(!selected)return;const el=selected.el;const c=centerOf(el);const nw=c.w*ZOOM,nh=c.h*ZOOM;el.setAttribute("x",c.cx-nw/2);el.setAttribute("y",c.cy-nh/2);el.setAttribute("width",nw);el.setAttribute("height",nh);applyRotate(el,rotationDeg);};
document.getElementById("smaller").onclick=()=>{if(!selected)return;const el=selected.el;const c=centerOf(el);const nw=c.w/ZOOM,nh=c.h/ZOOM;el.setAttribute("x",c.cx-nw/2);el.setAttribute("y",c.cy-nh/2);el.setAttribute("width",nw);el.setAttribute("height",nh);applyRotate(el,rotationDeg);};
document.getElementById("moveLeft").onclick=()=>{if(!selected)return;selected.angle=normalize(selected.angle-STEP);const el=selected.el;const w=parseFloat(el.getAttribute("width")),h=parseFloat(el.getAttribute("height"));const p=pos(selected.angle,w,h);el.setAttribute("x",p.x);el.setAttribute("y",p.y);};
document.getElementById("moveRight").onclick=()=>{if(!selected)return;selected.angle=normalize(selected.angle+STEP);const el=selected.el;const w=parseFloat(el.getAttribute("width")),h=parseFloat(el.getAttribute("height"));const p=pos(selected.angle,w,h);el.setAttribute("x",p.x);el.setAttribute("y",p.y);};
document.getElementById("delete").onclick=()=>{if(!selected)return;selected.el.remove();beads=beads.filter(b=>b!==selected);selected=null;editBar.classList.remove("show");};
document.getElementById("addPartBtn").onclick=()=>location.href="admin.html";
document.getElementById("partsBtn").onclick=()=>{document.getElementById("partsPanel").classList.add("open");loadPhotos();};
document.getElementById("saveBtn").onclick=()=>alert("ã‚¹ã‚¯ã‚·ãƒ§ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼");
function renderTabs(){
 colorTabs.innerHTML="";COLORS.forEach(c=>{const b=document.createElement("button");b.textContent=c;b.className="tab"+(c===activeColor?" active":"");b.onclick=()=>{activeColor=c;renderTabs();renderParts();};colorTabs.appendChild(b);});
}
async function loadPhotos(){
 try{
   const res=await fetch("/photos");const data=await res.json();photosCache=Array.isArray(data)?data:[];renderTabs();renderParts();
 }catch(e){partsContent.innerHTML="èª­ã¿è¾¼ã¿å¤±æ•—";}
}
function renderParts(){
 const list=photosCache.filter(p=>(p.color||"ãã®ä»–")===activeColor);
 const grid=document.createElement("div");grid.className="parts-grid";
 list.forEach(p=>{const img=document.createElement("img");img.src=p.listUrl;img.className="part-img";img.dataset.single=p.singleUrl;
   img.onclick=()=>addBead(p.singleUrl,-Math.PI/2);
   img.ondragstart=e=>{e.dataTransfer.setData("photo",JSON.stringify(p));};
   grid.appendChild(img);
 });
 partsContent.innerHTML="";partsContent.appendChild(grid);
}
svg.addEventListener("dragover",e=>e.preventDefault());
svg.addEventListener("drop",e=>{
 e.preventDefault();const raw=e.dataTransfer.getData("photo");if(!raw)return;const p=JSON.parse(raw);
 const rect=svg.getBoundingClientRect();const x=e.clientX-rect.left,y=e.clientY-rect.top;
 const angle=angleAt(x,y);addBead(p.singleUrl,angle);
});
</script>
</body>
</html>
