<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>+ILLuSio</title>
<link rel="stylesheet" href="style.css" />
<style>
   /* ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ãƒ‘ãƒ¼ãƒ„æ£š */
   .parts-panel {
     position: fixed;
     left: 0; right: 0;
     bottom: -60%;
     background: rgba(255,255,255,0.98);
     border-top: 2px solid #ccc;
     box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
     border-radius: 16px 16px 0 0;
     transition: bottom .35s ease-in-out;
     padding: 20px;
     text-align: center;
     max-height: 60%;
     overflow-y: auto;
     z-index: 10;
   }
   .parts-panel.open { bottom: 0; }
   .parts-grid{
     display:grid;
     grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));
     gap:15px; margin-top:10px;
   }
   .parts-grid img{
     width:100px; height:100px; object-fit:contain;
     border:1px solid #aaa; border-radius:8px;
     cursor:grab; background:#fff; transition:transform .15s;
   }
   .parts-grid img:active{ transform:scale(.95); }
   /* ç·¨é›†ãƒãƒ¼ï¼ˆé¸æŠä¸­ã®ãƒ“ãƒ¼ã‚ºã«è¡¨ç¤ºï¼‰ */
   .edit-bar{
     position:absolute;
     display:flex; gap:6px;
     background: rgba(0,0,0,.7);
     color:#fff; padding:6px 8px;
     border-radius:8px; z-index:20;
     pointer-events:auto;
   }
   .edit-bar.hidden{ display:none; }
   .edit-bar button{
     background:transparent; color:#fff; border:1px solid #fff;
     border-radius:6px; padding:4px 8px; font-size:14px;
   }
   /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåŸºæœ¬ */
   body{
     font-family:"Hiragino Sans",sans-serif;
     background:#f7f7f7; text-align:center; margin:0;
     height:100vh; display:flex; flex-direction:column; justify-content:space-between;
   }
   header{ position:relative; padding-top:10px; }
   .logo{ font-size:2rem; margin:.5rem 0 0; font-weight:bold; }
   .add-part{
     position:absolute; right:10px; top:10px;
     background:#fff; color:#333; border:1px solid #aaa; border-radius:6px; padding:5px 10px;
   }
   .main-area{ flex-grow:1; display:flex; justify-content:center; align-items:center; }
   .necklace-area{ position:relative; } /* ç·¨é›†ãƒãƒ¼ã®çµ¶å¯¾é…ç½®ã®è¦ª */
   .bottom-buttons{ display:flex; justify-content:center; gap:10px; padding:15px 0; }
   button{ background:#333; color:#fff; border:none; border-radius:6px; padding:10px 16px; font-size:.9rem; cursor:pointer; }
   button:hover{ background:#555; }
   .close-panel{ position:absolute; right:20px; top:10px; font-size:24px; cursor:pointer; }
</style>
</head>
<body>
<header>
<h1 class="logo">+ILLuSio</h1>
<button id="addPartBtn" class="add-part">ï¼‹ãƒ‘ãƒ¼ãƒ„è¿½åŠ </button>
</header>
<main class="main-area">
<div class="necklace-area" id="necklaceArea">
<!-- ç·¨é›†ãƒãƒ¼ï¼ˆä½ç½®ã¯JSã§å‹•ã‹ã™ï¼‰ -->
<div id="editBar" class="edit-bar hidden">
<button id="bigger">ï¼‹ å¤§ãã</button>
<button id="smaller">ï¼ å°ã•ã</button>
<button id="delete">å‰Šé™¤</button>
</div>
<svg id="necklaceCanvas" width="320" height="320">
<!-- ãƒ¯ã‚¤ãƒ¤ãƒ¼1æœ¬ã®ã¿ -->
<circle cx="160" cy="160" r="130" stroke="#bfbfbf" stroke-width="2" fill="none" />
</svg>
</div>
</main>
<footer class="bottom-buttons">
<button id="saveBtn">ğŸ’ ä¿å­˜</button>
<button id="partsBtn">ğŸ’  ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</button>
</footer>
<!-- ä¸‹ã‹ã‚‰å‡ºã‚‹ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ -->
<div id="partsPanel" class="parts-panel">
<span id="closePanel" class="close-panel">&times;</span>
<h2>ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</h2>
<div id="partsGrid" class="parts-grid"></div>
</div>
<script>
   // ç”»é¢é·ç§»
   document.getElementById("addPartBtn").addEventListener("click", () => {
     window.location.href = "admin.html";
   });
   // ãƒ‘ãƒ¼ãƒ„æ£š
   const partsBtn = document.getElementById("partsBtn");
   const panel = document.getElementById("partsPanel");
   const closePanel = document.getElementById("closePanel");
   const grid = document.getElementById("partsGrid");
   partsBtn.addEventListener("click", async () => { panel.classList.add("open"); await loadParts(); });
   closePanel.addEventListener("click", () => panel.classList.remove("open"));
   // SVG & ç·¨é›†ãƒãƒ¼
   const svg = document.getElementById("necklaceCanvas");
   const editBar = document.getElementById("editBar");
   const necklaceArea = document.getElementById("necklaceArea");
   const btnBig = document.getElementById("bigger");
   const btnSmall = document.getElementById("smaller");
   const btnDel = document.getElementById("delete");
   let selectedEl = null;     // é¸æŠä¸­ã® <image>
   let dragging = false;      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãƒ•ãƒ©ã‚°
   let dragOffset = { x: 0, y: 0 };
   // ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
   async function loadParts(){
     grid.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";
     try{
       const res = await fetch("/photos");
       const photos = await res.json();
       if(!photos.length){ grid.innerHTML = "<p>ãƒ‘ãƒ¼ãƒ„ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>"; return; }
       grid.innerHTML = "";
       photos.forEach(p=>{
         const img = document.createElement("img");
         img.src = p.listUrl;
         img.alt = p.color;
         img.draggable = true;
         // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹: dataTransferã«JSONã‚’å…¥ã‚Œã‚‹
         img.addEventListener("dragstart", e=>{
           e.dataTransfer.setData("part", JSON.stringify(p));
         });
         grid.appendChild(img);
       });
     }catch(err){
       grid.innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}</p>`;
     }
   }
   // SVGã«ãƒ‰ãƒ­ãƒƒãƒ— â†’ ç”»åƒã‚’é…ç½®
   svg.addEventListener("dragover", e => e.preventDefault());
   svg.addEventListener("drop", e=>{
     e.preventDefault();
     const data = JSON.parse(e.dataTransfer.getData("part"));
     const rect = svg.getBoundingClientRect();
     const x = e.clientX - rect.left;
     const y = e.clientY - rect.top;
     addBead(data.singleUrl, x, y, 35); // åˆæœŸã‚µã‚¤ã‚º35px
   });
   // è¿½åŠ ã—ãŸãƒ“ãƒ¼ã‚º(<image>)ã‚’ä½œæˆã—ã€ãƒ‰ãƒ©ãƒƒã‚°&é¸æŠå¯èƒ½ã«
   function addBead(href, x, y, size){
     const img = document.createElementNS("http://www.w3.org/2000/svg","image");
     img.setAttributeNS(null,"href", href);
     img.setAttributeNS(null,"x", x - size/2);
     img.setAttributeNS(null,"y", y - size/2);
     img.setAttributeNS(null,"width", size);
     img.setAttributeNS(null,"height", size);
     img.classList.add("bead");
     svg.appendChild(img);
     enableSelectableDraggable(img);
     selectBead(img); // è¿½åŠ ç›´å¾Œã«é¸æŠçŠ¶æ…‹ã«
   }
   // é¸æŠãƒãƒ¼ã‚’æ‰€å®šã®ä½ç½®ã«è¡¨ç¤º
   function showEditBarNear(el){
     const bb = el.getBoundingClientRect();
     const pa = necklaceArea.getBoundingClientRect();
     editBar.style.left = (bb.left - pa.left + bb.width/2 - editBar.offsetWidth/2) + "px";
     editBar.style.top  = (bb.top  - pa.top  - editBar.offsetHeight - 8) + "px";
     editBar.classList.remove("hidden");
   }
   function hideEditBar(){ editBar.classList.add("hidden"); }
   function selectBead(el){
     selectedEl = el;
     showEditBarNear(el);
   }
   // <image> ã‚’ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ & ãƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«
   function enableSelectableDraggable(el){
     // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
     el.addEventListener("pointerdown", (e)=>{
       e.preventDefault();
       selectBead(el);
       // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æº–å‚™
       const x = parseFloat(el.getAttribute("x")) || 0;
       const y = parseFloat(el.getAttribute("y")) || 0;
       const rect = svg.getBoundingClientRect();
       const px = e.clientX - rect.left;
       const py = e.clientY - rect.top;
       dragOffset.x = px - x;
       dragOffset.y = py - y;
       dragging = true;
       el.setPointerCapture(e.pointerId);
     });
     // ç§»å‹•
     el.addEventListener("pointermove", (e)=>{
       if(!dragging) return;
       const rect = svg.getBoundingClientRect();
       const px = e.clientX - rect.left;
       const py = e.clientY - rect.top;
       const nx = px - dragOffset.x;
       const ny = py - dragOffset.y;
       el.setAttribute("x", nx);
       el.setAttribute("y", ny);
       showEditBarNear(el);
     });
     // çµ‚äº†
     el.addEventListener("pointerup", (e)=>{
       dragging = false;
       el.releasePointerCapture(e.pointerId);
     });
     // å¤–å´ã‚¿ãƒƒãƒ—ã§ç·¨é›†ãƒãƒ¼ã‚’éš ã™
     svg.addEventListener("pointerdown",(e)=>{
       if(e.target.tagName.toLowerCase() !== "image"){
         selectedEl = null;
         hideEditBar();
       }
     });
   }
   // ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³
   btnBig.addEventListener("click", ()=>{
     if(!selectedEl) return;
     const w = parseFloat(selectedEl.getAttribute("width"));
     const h = parseFloat(selectedEl.getAttribute("height"));
     const x = parseFloat(selectedEl.getAttribute("x"));
     const y = parseFloat(selectedEl.getAttribute("y"));
     const nw = Math.min(w * 1.15, 140); // ä¸Šé™
     const nh = Math.min(h * 1.15, 140);
     // ä¸­å¿ƒã‚’ä¿ã£ãŸã¾ã¾æ‹¡å¤§
     selectedEl.setAttribute("x", x - (nw - w)/2);
     selectedEl.setAttribute("y", y - (nh - h)/2);
     selectedEl.setAttribute("width", nw);
     selectedEl.setAttribute("height", nh);
     showEditBarNear(selectedEl);
   });
   btnSmall.addEventListener("click", ()=>{
     if(!selectedEl) return;
     const w = parseFloat(selectedEl.getAttribute("width"));
     const h = parseFloat(selectedEl.getAttribute("height"));
     const x = parseFloat(selectedEl.getAttribute("x"));
     const y = parseFloat(selectedEl.getAttribute("y"));
     const nw = Math.max(w / 1.15, 16);  // ä¸‹é™
     const nh = Math.max(h / 1.15, 16);
     selectedEl.setAttribute("x", x - (nw - w)/2);
     selectedEl.setAttribute("y", y - (nh - h)/2);
     selectedEl.setAttribute("width", nw);
     selectedEl.setAttribute("height", nh);
     showEditBarNear(selectedEl);
   });
   // å‰Šé™¤ãƒœã‚¿ãƒ³
   btnDel.addEventListener("click", ()=>{
     if(!selectedEl) return;
     selectedEl.remove();
     selectedEl = null;
     hideEditBar();
   });
   // ä¿å­˜ï¼ˆã„ã¾ã¯ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã‚¹ã‚¯ã‚·ãƒ§æ¨å¥¨ã€‚å¿…è¦ãªã‚‰html2canvaså°å…¥å¯èƒ½ï¼‰
   document.getElementById("saveBtn").addEventListener("click", ()=>{
     alert("ä¿å­˜ã¯ã€ç«¯æœ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ãŠé¡˜ã„ã—ã¾ã™ï¼ˆç”»åƒåŒ–æ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…å¯èƒ½ï¼‰");
   });
</script>
</body>
</html>
