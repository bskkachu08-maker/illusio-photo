<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>+ILLuSio</title>
<style>
 :root{
   --wire:#bfbfbf;
   --panel-bg:#fff;
 }
 body{
   margin:0;
   font-family:"Hiragino Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
   background:#f7f7f7;
   color:#111;
   height:100vh;
   display:flex;
   flex-direction:column;
   text-align:center;
 }
 header{ position:relative; padding:10px 0 0; }
 .logo{ font-weight:700; font-size:2rem; margin:.5rem 0 0; }
 .add-part{
   position:absolute; right:10px; top:10px;
   background:#111; color:#fff;
   border:0; border-radius:10px; padding:8px 12px;
   cursor:pointer; font-weight:600;
 }
 .add-part:hover{ opacity:.9; }
 .main-area{ flex:1; display:flex; align-items:center; justify-content:center; }
 .necklace-area{ position:relative; }
 svg{ display:block; }
 .bottom-buttons{
   display:flex; gap:10px; justify-content:center;
   padding:12px 0 16px;
 }
 .btn{
   background:#111; color:#fff;
   border:0; border-radius:10px;
   padding:10px 14px; cursor:pointer;
 }
 .btn:hover{ opacity:.9; }
 /* „Éë„Éº„ÉÑ‰∏ÄË¶ßÔºà‰∏ã„Åã„Çâ„Çπ„É©„Ç§„ÉâÔºâ */
 .parts-panel{
   position:fixed; left:0; right:0; bottom:-65%;
   background:var(--panel-bg);
   border-top:2px solid #e6e6e6;
   border-radius:16px 16px 0 0;
   box-shadow:0 -8px 24px rgba(0,0,0,.12);
   transition:bottom .35s ease;
   padding:14px 14px 24px;
   z-index:10; max-height:65%;
   overflow:auto; text-align:left;
 }
 .parts-panel.open{ bottom:0; }
 .panel-header{
   display:flex; align-items:center; justify-content:space-between; gap:10px;
 }
 .close-panel{ font-size:26px; cursor:pointer; padding:6px 10px; }
 .color-tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:8px 0 6px; }
 .tab{
   border:1px solid #ddd; background:#fff; color:#111;
   padding:6px 10px; border-radius:999px;
   font-size:.9rem; cursor:pointer;
 }
 .tab.active{ background:#111; color:#fff; border-color:#111; }
 .group-title{ margin:10px 2px 6px; font-weight:700; }
 .parts-grid{
   display:grid;
   grid-template-columns:repeat(2,minmax(0,1fr));
   gap:10px; margin-bottom:14px;
 }
 .part-img{
   width:100%; aspect-ratio:1/1;
   object-fit:contain; background:#fff;
   border:1px solid #ddd; border-radius:10px;
   cursor:grab;
 }
 /* Êìç‰Ωú„Éê„ÉºÔºàÂè≥‰∏ãÂõ∫ÂÆöÔºâ */
 .edit-bar{
   position:fixed; right:16px; bottom:16px;
   display:none; flex-direction:column; gap:10px;
   background:#111; color:#fff;
   padding:14px; border-radius:16px;
   z-index:100; box-shadow:0 8px 24px rgba(0,0,0,.35);
 }
 .edit-bar.show{ display:flex; }
 .edit-row{ display:flex; gap:8px; justify-content:center; }
 .ctrl{
   width:46px; height:46px;
   border-radius:12px; border:1px solid rgba(255,255,255,.22);
   background:#111; color:#fff;
   font-size:18px; font-weight:700; cursor:pointer;
   transition:transform .12s ease, background .12s ease;
 }
 .ctrl:hover{ background:#222; transform:scale(1.06); }
 @media (max-width:420px){
   #canvas{ width:300px; height:300px; }
   #wire{ cx:150px; cy:150px; r:125px; }
 }
</style>
</head>
<body>
<header>
<h1 class="logo">+ILLuSio</h1>
<button id="addPartBtn" class="add-part">Ôºã„Éë„Éº„ÉÑËøΩÂä†</button>
</header>
<main class="main-area">
<div class="necklace-area" id="necklaceArea">
<svg id="canvas" width="340" height="340">
<circle id="wire" cx="170" cy="170" r="140" stroke="var(--wire)" stroke-width="2" fill="none"/>
</svg>
</div>
</main>
<footer class="bottom-buttons">
<button id="saveBtn"  class="btn">üíé ‰øùÂ≠ò</button>
<button id="partsBtn" class="btn">üí† „Éë„Éº„ÉÑ‰∏ÄË¶ß</button>
</footer>
<!-- „Éë„Éº„ÉÑ‰∏ÄË¶ß„Éë„Éç„É´ -->
<div id="partsPanel" class="parts-panel">
<div class="panel-header">
<strong>„Éë„Éº„ÉÑ‰∏ÄË¶ß</strong>
<span id="closePanel" class="close-panel">&times;</span>
</div>
<div id="colorTabs" class="color-tabs"></div>
<div id="partsContent"></div>
</div>
<!-- Êìç‰Ωú„Éê„Éº -->
<div id="editBar" class="edit-bar">
<div class="edit-row">
<button id="rotateL" class="ctrl" title="Â∑¶ÂõûËª¢">‚Ü∫</button>
<button id="rotateR" class="ctrl" title="Âè≥ÂõûËª¢">‚Üª</button>
</div>
<div class="edit-row">
<button id="bigger"  class="ctrl" title="Êã°Â§ß">Ôºã</button>
<button id="smaller" class="ctrl" title="Á∏ÆÂ∞è">Ôºç</button>
</div>
<div class="edit-row">
<button id="moveLeft"  class="ctrl" title="Â∑¶„Å∏">‚Üê</button>
<button id="moveRight" class="ctrl" title="Âè≥„Å∏">‚Üí</button>
</div>
<button id="delete" class="ctrl" title="ÂâäÈô§">üóë</button>
</div>
<script>
 const svg = document.getElementById("canvas");
 const wire = document.getElementById("wire");
 const addPartBtn = document.getElementById("addPartBtn");
 const partsBtn = document.getElementById("partsBtn");
 const partsPanel = document.getElementById("partsPanel");
 const closePanel = document.getElementById("closePanel");
 const colorTabs = document.getElementById("colorTabs");
 const partsContent = document.getElementById("partsContent");
 const editBar = document.getElementById("editBar");
 const btnRotL = document.getElementById("rotateL");
 const btnRotR = document.getElementById("rotateR");
 const btnBig  = document.getElementById("bigger");
 const btnSmall= document.getElementById("smaller");
 const btnLeft = document.getElementById("moveLeft");
 const btnRight= document.getElementById("moveRight");
 const btnDel  = document.getElementById("delete");
 let beads = [];
 let selected = null;
 let rotationDeg = 0;
 let lastActionAt = 0;
 const STEP_DEG = 6;
 const ZOOM_SCALE = 1.5;
 function getCircle(){
   return {
     cx: parseFloat(wire.getAttribute("cx")),
     cy: parseFloat(wire.getAttribute("cy")),
     r:  parseFloat(wire.getAttribute("r")),
   };
 }
 function canAct(interval=120){
   const now = Date.now();
   if(now - lastActionAt < interval) return false;
   lastActionAt = now;
   return true;
 }
 function normalize(a){
   while(a <= -Math.PI) a += 2*Math.PI;
   while(a >   Math.PI) a -= 2*Math.PI;
   return a;
 }
 function angleAtPoint(x,y){
   const {cx,cy} = getCircle();
   return Math.atan2(y - cy, x - cx);
 }
 function posFromAngle(angle,w=35,h=35){
   const {cx,cy,r} = getCircle();
   const px = cx + r * Math.cos(angle);
   const py = cy + r * Math.sin(angle);
   return { x: px - w/2, y: py - h/2 };
 }
 function centerOf(el){
   const x = parseFloat(el.getAttribute("x"));
   const y = parseFloat(el.getAttribute("y"));
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   return { x, y, w, h, cx: x + w/2, cy: y + h/2 };
 }
 function applyCenterRotate(el, deg){
   el.dataset.rotate = String(deg);
   const c = centerOf(el);
   el.setAttribute("transform", `rotate(${deg}, ${c.cx}, ${c.cy})`);
 }
 // üß© „Éç„ÉÉ„ÇØ„É¨„ÇπÂõ∫ÂÆöÔºàÂÖ®‰ΩìÂÜçÈÖçÁΩÆ„Åó„Å™„ÅÑÔºâ
 function insertAtAngle(bead, targetAngle) {
   beads.push(bead);
   bead.angle = normalize(targetAngle);
   const el = bead.el;
   const w = parseFloat(el.getAttribute("width")) || 35;
   const h = parseFloat(el.getAttribute("height")) || 35;
   const p = posFromAngle(bead.angle, w, h);
   el.setAttribute("x", p.x);
   el.setAttribute("y", p.y);
   applyCenterRotate(el, parseFloat(el.dataset.rotate || "0"));
 }
 function addBead(singleUrl, angle){
   const el = document.createElementNS("http://www.w3.org/2000/svg","image");
   el.setAttributeNS(null,"href", singleUrl);
   el.setAttributeNS(null,"width", 35);
   el.setAttributeNS(null,"height",35);
   el.dataset.rotate = "0";
   svg.appendChild(el);
   const bead = { el, angle: normalize(angle) };
   insertAtAngle(bead, angle);
   let dragging = false;
   el.addEventListener("pointerdown", e=>{
     e.preventDefault();
     selectBead(el);
     dragging = true;
     el.setPointerCapture(e.pointerId);
   });
   el.addEventListener("pointermove", e=>{
     if(!dragging) return;
     const rect = svg.getBoundingClientRect();
     const mx = e.clientX - rect.left;
     const my = e.clientY - rect.top;
     const ang = angleAtPoint(mx, my);
     bead.angle = normalize(ang);
     const w = parseFloat(el.getAttribute("width"));
     const h = parseFloat(el.getAttribute("height"));
     const p = posFromAngle(bead.angle, w, h);
     el.setAttribute("x", p.x);
     el.setAttribute("y", p.y);
     applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
   });
   el.addEventListener("pointerup", e=>{
     dragging = false;
     el.releasePointerCapture(e.pointerId);
     selectBead(el);
   });
   el.addEventListener("click", ()=> selectBead(el));
 }
 function selectBead(el){
   selected = beads.find(b => b.el === el) || null;
   if(!selected){ editBar.classList.remove("show"); return; }
   rotationDeg = parseFloat(el.dataset.rotate || "0");
   editBar.classList.add("show");
 }
 svg.addEventListener("pointerdown", e=>{
   if(e.target.tagName.toLowerCase()!=="image"){
     selected=null;
     editBar.classList.remove("show");
   }
 });
 // ÂõûËª¢„ÉªÊã°Â§ß„ÉªÁ∏ÆÂ∞è„ÉªÂ∑¶Âè≥ÁßªÂãï„ÉªÂâäÈô§
 btnRotL.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg -= 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 btnRotR.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg += 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 function resizeSelected(scale){
   const el = selected.el;
   const c  = centerOf(el);
   const nw = Math.min(Math.max(c.w*scale, 16), 240);
   const nh = Math.min(Math.max(c.h*scale, 16), 240);
   el.setAttribute("x", c.cx - nw/2);
   el.setAttribute("y", c.cy - nh/2);
   el.setAttribute("width", nw);
   el.setAttribute("height",nh);
   applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
 }
 btnBig.addEventListener("click", ()=>{ if(!selected||!canAct())return; resizeSelected(1.5); });
 btnSmall.addEventListener("click", ()=>{ if(!selected||!canAct())return; resizeSelected(1/1.5); });
 function moveAlong(sign){
   if(!selected) return;
   const bead = selected;
   bead.angle = normalize(bead.angle + sign * STEP_DEG * Math.PI/180);
   const el = bead.el;
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   const p = posFromAngle(bead.angle, w, h);
   el.setAttribute("x", p.x);
   el.setAttribute("y", p.y);
 }
 btnLeft.addEventListener("click", ()=>{ if(!selected||!canAct())return; moveAlong(-1); });
 btnRight.addEventListener("click", ()=>{ if(!selected||!canAct())return; moveAlong(+1); });
 btnDel.addEventListener("click", ()=>{
   if(!selected) return;
   selected.el.remove();
   beads = beads.filter(b=>b!==selected);
   selected=null; editBar.classList.remove("show");
 });
 // „Éë„Éº„ÉÑ‰∏ÄË¶ßÔºàËâ≤Âà•2ÂàóÔºâ
 let photosCache = [];
 let activeColor = "Ëµ§";
 const COLORS_ORDER = ["Ëµ§","„Éî„É≥„ÇØ","Èùí","Á∑ë","ÁôΩ","Á¥´","„Çø„Éº„Ç≥„Ç§„Ç∫","ÈÄèÊòé","ÈáëËâ≤","„Ç∑„É´„Éê„Éº","Èªí","„Åù„ÅÆ‰ªñ"];
 let availableColors = [];
 async function loadPhotos(){
   try{
     const res = await fetch("/photos");
     const json = await res.json();
     photosCache = Array.isArray(json) ? json : [];
     const set = new Set(photosCache.map(p=>p.color||"„Åù„ÅÆ‰ªñ"));
     availableColors = COLORS_ORDER.filter(c=>set.has(c));
     if(availableColors.length===0) availableColors=["„Åù„ÅÆ‰ªñ"];
     if(!availableColors.includes(activeColor)) activeColor=availableColors[0];
     renderTabs(); renderParts(activeColor);
   }catch(e){
     partsContent.innerHTML = `<p style="color:#c00;">Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${e.message}</p>`;
   }
 }
 function renderTabs(){
   colorTabs.innerHTML="";
   availableColors.forEach(c=>{
     const btn=document.createElement("button");
     btn.className="tab"+(c===activeColor?" active":"");
     btn.textContent=c;
     btn.addEventListener("click",()=>{
       activeColor=c;
       document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
       btn.classList.add("active");
       renderParts(c);
     });
     colorTabs.appendChild(btn);
   });
 }
 function renderParts(color){
   const list=photosCache.filter(p=>(p.color||"„Åù„ÅÆ‰ªñ")===color);
   const title=`<div class="group-title">${color}Á≥ª</div>`;
   const gridOpen=`<div class="parts-grid">`;
   const gridClose=`</div>`;
   if(list.length===0){
     partsContent.innerHTML=title+`<p style="opacity:.7;">„Åì„ÅÆËâ≤„ÅÆ„Éë„Éº„ÉÑ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>`;
     return;
   }
   const html=list.map(p=>`<img class="part-img" draggable="true" src="${p.listUrl}" data-single="${p.singleUrl}" alt="${p.color||""}">`).join("");
   partsContent.innerHTML=title+gridOpen+html+gridClose;
   partsContent.querySelectorAll(".part-img").forEach(img=>{
     img.addEventListener("dragstart", e=>{
       e.dataTransfer.setData("photo", JSON.stringify({singleUrl:img.dataset.single, color}));
     });
     img.addEventListener("click", ()=>{
       addBead(img.dataset.single, -Math.PI/2);
     });
   });
 }
 svg.addEventListener("dragover", e=>e.preventDefault());
 svg.addEventListener("drop", e=>{
   e.preventDefault();
   const raw=e.dataTransfer.getData("photo");
   if(!raw) return;
   const p=JSON.parse(raw);
   const rect=svg.getBoundingClientRect();
   const x=e.clientX-rect.left;
   const y=e.clientY-rect.top;
   const angle=angleAtPoint(x,y);
   addBead(p.singleUrl, angle);
 });
 addPartBtn.addEventListener("click", ()=>location.href="admin.html");
 partsBtn.addEventListener("click", async()=>{ partsPanel.classList.add("open"); await loadPhotos(); });
 closePanel.addEventListener("click", ()=>partsPanel.classList.remove("open"));
 document.getElementById("saveBtn").addEventListener("click", ()=>alert("‰øùÂ≠ò„ÅØ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô"));
</script>
</body>
</html>
