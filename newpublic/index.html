<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>+ILLuSio</title>
<style>
 :root{
   --wire:#bfbfbf;
   --panel-bg:#fff;
 }
 body{
   margin:0; font-family:"Hiragino Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
   background:#f7f7f7; color:#111; height:100vh; display:flex; flex-direction:column; text-align:center;
 }
 header{ position:relative; padding:10px 0 0; }
 .logo{ font-weight:700; font-size:2rem; margin:.5rem 0 0; }
 .add-part{
   position:absolute; right:10px; top:10px; background:#111; color:#fff;
   border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:600;
 }
 .add-part:hover{ opacity:.9; }
 .main-area{ flex:1; display:flex; align-items:center; justify-content:center; }
 .necklace-area{ position:relative; }
 svg{ display:block; }
 .bottom-buttons{ display:flex; gap:10px; justify-content:center; padding:12px 0 16px; }
 .btn{ background:#111; color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; }
 .btn:hover{ opacity:.9; }
 /* ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ï¼ˆä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ */
 .parts-panel{
   position:fixed; left:0; right:0; bottom:-65%;
   background:var(--panel-bg); border-top:2px solid #e6e6e6; border-radius:16px 16px 0 0;
   box-shadow:0 -8px 24px rgba(0,0,0,.12); transition:bottom .35s ease; padding:14px 14px 24px; z-index:10;
   max-height:65%; overflow:auto; text-align:left;
 }
 .parts-panel.open{ bottom:0; }
 .panel-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
 .close-panel{ font-size:26px; cursor:pointer; padding:6px 10px; }
 .color-tabs{ display:flex; gap:8px; flex-wrap:wrap; padding:8px 0 6px; }
 .tab{
   border:1px solid #ddd; background:#fff; color:#111; padding:6px 10px; border-radius:999px;
   font-size:.9rem; cursor:pointer;
 }
 .tab.active{ background:#111; color:#fff; border-color:#111; }
 .group-title{ margin:10px 2px 6px; font-weight:700; }
 .parts-grid{
   display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-bottom:14px;
 }
 .part-img{
   width:100%; aspect-ratio:1/1; object-fit:contain; background:#fff; border:1px solid #ddd; border-radius:10px;
   cursor:grab;
 }
 /* æ“ä½œãƒãƒ¼ï¼ˆé»’åŸºèª¿ãƒ»å³ä¸‹å›ºå®šï¼‰ */
 .edit-bar{
   position:fixed; right:16px; bottom:16px; display:none; flex-direction:column; gap:10px;
   background:#111; color:#fff; padding:14px; border-radius:16px; z-index:100; box-shadow:0 8px 24px rgba(0,0,0,.35);
 }
 .edit-bar.show{ display:flex; }
 .edit-row{ display:flex; gap:8px; justify-content:center; }
 .ctrl{
   width:46px; height:46px; border-radius:12px; border:1px solid rgba(255,255,255,.22);
   background:#111; color:#fff; font-size:18px; font-weight:700; cursor:pointer;
   transition:transform .12s ease, background .12s ease;
 }
 .ctrl:hover{ background:#222; transform:scale(1.06); }
 /* å°ã•ã‚ç«¯æœ«ã§ãƒãƒƒã‚¯ãƒ¬ã‚¹ã‚’å°‘ã—å°ã•ã */
 @media (max-width:420px){
   #canvas{ width:300px; height:300px; }
   #wire{ cx:150px; cy:150px; r:125px; }
 }
</style>
</head>
<body>
<header>
<h1 class="logo">+ILLuSio</h1>
<button id="addPartBtn" class="add-part">ï¼‹ãƒ‘ãƒ¼ãƒ„è¿½åŠ </button>
</header>
<main class="main-area">
<div class="necklace-area" id="necklaceArea">
<svg id="canvas" width="340" height="340">
<circle id="wire" cx="170" cy="170" r="140" stroke="var(--wire)" stroke-width="2" fill="none"/>
</svg>
</div>
</main>
<footer class="bottom-buttons">
<button id="saveBtn"  class="btn">ğŸ’ ä¿å­˜</button>
<button id="partsBtn" class="btn">ğŸ’  ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</button>
</footer>
<!-- ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ãƒ‘ãƒãƒ« -->
<div id="partsPanel" class="parts-panel">
<div class="panel-header">
<strong>ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</strong>
<span id="closePanel" class="close-panel">&times;</span>
</div>
<!-- è‰²ã‚¿ãƒ– -->
<div id="colorTabs" class="color-tabs"></div>
<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<div id="partsContent"></div>
</div>
<!-- æ“ä½œãƒãƒ¼ï¼ˆâ†‘â†“ç„¡ã—ï¼‰ -->
<div id="editBar" class="edit-bar">
<div class="edit-row">
<button id="rotateL" class="ctrl" title="å·¦å›è»¢">â†º</button>
<button id="rotateR" class="ctrl" title="å³å›è»¢">â†»</button>
</div>
<div class="edit-row">
<button id="bigger"  class="ctrl" title="æ‹¡å¤§">ï¼‹</button>
<button id="smaller" class="ctrl" title="ç¸®å°">ï¼</button>
</div>
<div class="edit-row">
<button id="moveLeft"  class="ctrl" title="å·¦ã¸">â†</button>
<button id="moveRight" class="ctrl" title="å³ã¸">â†’</button>
</div>
<button id="delete" class="ctrl" title="å‰Šé™¤">ğŸ—‘</button>
</div>
<script>
 // === è¦ç´ å‚ç…§ ===
 const svg = document.getElementById("canvas");
 const wire = document.getElementById("wire");
 const addPartBtn = document.getElementById("addPartBtn");
 const partsBtn = document.getElementById("partsBtn");
 const partsPanel = document.getElementById("partsPanel");
 const closePanel = document.getElementById("closePanel");
 const colorTabs = document.getElementById("colorTabs");
 const partsContent = document.getElementById("partsContent");
 const editBar = document.getElementById("editBar");
 const btnRotL = document.getElementById("rotateL");
 const btnRotR = document.getElementById("rotateR");
 const btnBig  = document.getElementById("bigger");
 const btnSmall= document.getElementById("smaller");
 const btnLeft = document.getElementById("moveLeft");
 const btnRight= document.getElementById("moveRight");
 const btnDel  = document.getElementById("delete");
 // === å††ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
 function getCircle(){
   return {
     cx: parseFloat(wire.getAttribute("cx")),
     cy: parseFloat(wire.getAttribute("cy")),
     r:  parseFloat(wire.getAttribute("r")),
   };
 }
 // === çŠ¶æ…‹ ===
 let beads = []; // {el, angle(rad)}
 let selected = null; // beadsã®è¦ç´ 
 let rotationDeg = 0;
 let lastActionAt = 0;
 const STEP_DEG = 6; // â†â†’ã§å‹•ãè§’åº¦
 const ZOOM_SCALE = 1.5; // 1ã‚¿ãƒƒãƒ—ã§1.5å€/0.67å€
 const COLORS_ORDER = ["èµ¤","ãƒ”ãƒ³ã‚¯","é’","ç·‘","ç™½","ç´«","ã‚¿ãƒ¼ã‚³ã‚¤ã‚º","é€æ˜","é‡‘è‰²","ã‚·ãƒ«ãƒãƒ¼","é»’","ãã®ä»–"];
 let availableColors = [];
 // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
 function canAct(interval=120){
   const now = Date.now();
   if(now - lastActionAt < interval) return false;
   lastActionAt = now;
   return true;
 }
 function normalize(a){
   while(a <= -Math.PI) a += 2*Math.PI;
   while(a >   Math.PI) a -= 2*Math.PI;
   return a;
 }
 function angleAtPoint(x,y){
   const {cx,cy} = getCircle();
   return Math.atan2(y - cy, x - cx);
 }
 function posFromAngle(angle,w=35,h=35){
   const {cx,cy,r} = getCircle();
   const px = cx + r * Math.cos(angle);
   const py = cy + r * Math.sin(angle);
   return { x: px - w/2, y: py - h/2 };
 }
 function centerOf(el){
   const x = parseFloat(el.getAttribute("x"));
   const y = parseFloat(el.getAttribute("y"));
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   return { x, y, w, h, cx: x + w/2, cy: y + h/2 };
 }
 function applyCenterRotate(el, deg){
   el.dataset.rotate = String(deg);
   const c = centerOf(el);
   el.setAttribute("transform", `rotate(${deg}, ${c.cx}, ${c.cy})`);
 }
 // === ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆç­‰é–“éš”æ•´åˆ—ãƒ»å…¥ã‚Œæ›¿ãˆï¼‰ ===
 function layoutAll(anchorIndex=null){
   const n = beads.length;
   if(n===0) return;
   if(n===1){
     const b = beads[0], el = b.el;
     const w = parseFloat(el.getAttribute("width"))||35;
     const h = parseFloat(el.getAttribute("height"))||35;
     const p = posFromAngle(b.angle,w,h);
     el.setAttribute("x",p.x); el.setAttribute("y",p.y);
     applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
     return;
   }
   const base = (anchorIndex===null)? 0 : anchorIndex;
   const baseAngle = beads[base].angle;
   const step = 2*Math.PI / n;
   for(let i=0;i<n;i++){
     const idx = i;
     const a = normalize(baseAngle + (idx - base)*step);
     beads[idx].angle = a;
     const el = beads[idx].el;
     const w = parseFloat(el.getAttribute("width"))||35;
     const h = parseFloat(el.getAttribute("height"))||35;
     const p = posFromAngle(a,w,h);
     el.setAttribute("x",p.x); el.setAttribute("y",p.y);
     applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
   }
 }
 function insertAtAngle(bead, targetAngle){
   beads = beads.filter(b => b !== bead);
   if(beads.length===0){
     bead.angle = normalize(targetAngle);
     beads.push(bead);
     layoutAll(0);
     return;
   }
   let nearIdx = 0, minDiff = Infinity;
   beads.forEach((b,i)=>{
     const d = Math.abs(normalize(targetAngle - b.angle));
     if(d < minDiff){ minDiff = d; nearIdx = i; }
   });
   const insertIndex = nearIdx + 1;
   beads.splice(insertIndex,0,bead);
   bead.angle = normalize(targetAngle);
   layoutAll(insertIndex);
 }
 // === ãƒ“ãƒ¼ã‚ºè¿½åŠ ï¼ˆä¸€è¦§â†’ãƒ‰ãƒ©ãƒƒã‚° or ã‚¿ãƒƒãƒ—é…ç½®ï¼‰ ===
 function addBead(singleUrl, angle){
   const el = document.createElementNS("http://www.w3.org/2000/svg","image");
   el.setAttributeNS(null,"href", singleUrl);
   el.setAttributeNS(null,"width", 35);
   el.setAttributeNS(null,"height",35);
   el.dataset.rotate = "0";
   svg.appendChild(el);
   const bead = { el, angle: normalize(angle) };
   insertAtAngle(bead, angle);
   // ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ï¼šå††ä¸Šã®ã¿è¿½å¾“
   let dragging = false;
   el.addEventListener("pointerdown", (e)=>{
     e.preventDefault();
     selectBead(el);
     dragging = true;
     el.setPointerCapture(e.pointerId);
   });
   el.addEventListener("pointermove", (e)=>{
     if(!dragging) return;
     const rect = svg.getBoundingClientRect();
     const mx = e.clientX - rect.left;
     const my = e.clientY - rect.top;
     const ang = angleAtPoint(mx, my);
     bead.angle = normalize(ang);
     const w = parseFloat(el.getAttribute("width"));
     const h = parseFloat(el.getAttribute("height"));
     const p = posFromAngle(bead.angle, w, h);
     el.setAttribute("x", p.x);
     el.setAttribute("y", p.y);
     applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
   });
   el.addEventListener("pointerup", (e)=>{
     dragging = false;
     el.releasePointerCapture(e.pointerId);
     insertAtAngle(bead, bead.angle); // é›¢ã—ãŸä½ç½®ã§å†æ•´åˆ—ï¼ˆå…¥ã‚Œæ›¿ãˆï¼‰
     selectBead(el);
   });
   el.addEventListener("click", ()=> selectBead(el));
 }
 // === é¸æŠ ===
 function selectBead(el){
   selected = beads.find(b => b.el === el) || null;
   if(!selected){ editBar.classList.remove("show"); return; }
   rotationDeg = parseFloat(el.dataset.rotate || "0");
   editBar.classList.add("show");
 }
 svg.addEventListener("pointerdown", e=>{
   if(e.target.tagName.toLowerCase()!=="image"){
     selected=null; editBar.classList.remove("show");
   }
 });
 // === æ“ä½œï¼šå›è»¢ï¼ˆä¸­å¿ƒåŸºæº– 15Â°ï¼‰ ===
 btnRotL.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg -= 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 btnRotR.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg += 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 // === æ“ä½œï¼šæ‹¡å¤§ç¸®å°ï¼ˆå¼·ã‚ï¼‹èª¤é€£æ‰“ã‚¬ãƒ¼ãƒ‰ï¼‰ ===
 function resizeSelected(scale){
   const el = selected.el;
   const c  = centerOf(el);
   const nw = Math.min(Math.max(c.w*scale, 16), 240);
   const nh = Math.min(Math.max(c.h*scale, 16), 240);
   el.setAttribute("x", c.cx - nw/2);
   el.setAttribute("y", c.cy - nh/2);
   el.setAttribute("width", nw);
   el.setAttribute("height",nh);
   // å›è»¢ä¸­å¿ƒã¯å¸¸ã«è‡ªåˆ†ã®ä¸­å¿ƒ
   applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
 }
 btnBig.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   resizeSelected(ZOOM_SCALE);      // 1.5å€
 });
 btnSmall.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   resizeSelected(1/ZOOM_SCALE);    // ç´„0.67å€
 });
 // === æ“ä½œï¼šå·¦å³ç§»å‹•ï¼ˆå††å‘¨ã«æ²¿ã£ã¦ã®ã¿ï¼‰ ===
 function moveAlong(sign){ // sign: +1(â†’ = CW), -1(â† = CCW)
   const bead = selected;
   if(!bead) return;
   bead.angle = normalize(bead.angle + sign * STEP_DEG * Math.PI/180);
   const el = bead.el;
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   const p = posFromAngle(bead.angle, w, h);
   el.setAttribute("x", p.x);
   el.setAttribute("y", p.y);
   applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
 }
 btnLeft .addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(-1); });
 btnRight.addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(+1); });
 // === å‰Šé™¤ ===
 btnDel.addEventListener("click", ()=>{
   if(!selected) return;
   selected.el.remove();
   beads = beads.filter(b => b !== selected);
   selected = null;
   editBar.classList.remove("show");
   if(beads.length) layoutAll(0);
 });
 // === ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ï¼šè‰²ã‚¿ãƒ– & 2åˆ—è¡¨ç¤º ===
 let photosCache = [];
 let activeColor = "èµ¤"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
 async function loadPhotos(){
   try{
     const res = await fetch("/photos");
     const json = await res.json();
     photosCache = Array.isArray(json) ? json : [];
     // åˆ©ç”¨å¯èƒ½è‰²ã‚’æŠ½å‡ºï¼ˆæ—¢å®šé †å„ªå…ˆï¼‰
     const set = new Set(photosCache.map(p => p.color || "ãã®ä»–"));
     availableColors = COLORS_ORDER.filter(c => set.has(c));
     if(availableColors.length===0){ availableColors = ["ãã®ä»–"]; }
     if(!availableColors.includes(activeColor)) activeColor = availableColors[0];
     renderTabs();
     renderParts(activeColor);
   }catch(e){
     partsContent.innerHTML = `<p style="color:#c00;">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</p>`;
   }
 }
 function renderTabs(){
   colorTabs.innerHTML = "";
   availableColors.forEach(c=>{
     const btn = document.createElement("button");
     btn.className = "tab" + (c===activeColor ? " active": "");
     btn.textContent = c;
     btn.addEventListener("click", ()=>{
       activeColor = c;
       document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
       btn.classList.add("active");
       renderParts(c);
     });
     colorTabs.appendChild(btn);
   });
 }
 function renderParts(color){
   // æŒ‡å®šè‰²ã®ã¿ 2åˆ—ã‚°ãƒªãƒƒãƒ‰ã§è¡¨ç¤º
   const list = photosCache.filter(p => (p.color||"ãã®ä»–") === color);
   const title = `<div class="group-title">${color}ç³»</div>`;
   const gridOpen = `<div class="parts-grid">`;
   const gridClose= `</div>`;
   if(list.length===0){
     partsContent.innerHTML = title + `<p style="opacity:.7; margin:8px 2px 16px;">ã“ã®è‰²ã®ãƒ‘ãƒ¼ãƒ„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
     return;
   }
   const html = list.map(p=>`<img class="part-img" draggable="true" src="${p.listUrl}" data-single="${p.singleUrl}" alt="${p.color||""}">`).join("");
   partsContent.innerHTML = title + gridOpen + html + gridClose;
   // D&Dã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸é…ç½®
   partsContent.querySelectorAll(".part-img").forEach(img=>{
     img.addEventListener("dragstart", e=>{
       e.dataTransfer.setData("photo", JSON.stringify({singleUrl: img.dataset.single, listUrl: img.src, color: color}));
     });
     // ã‚¿ãƒƒãƒ—ã§ã‚‚é…ç½®ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
     img.addEventListener("click", ()=>{
       // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰æ­£é¢ã®12æ™‚æ–¹å‘ã«ä»®é…ç½®ï¼ˆã¾ãŸã¯ãƒ©ãƒ³ãƒ€ãƒ è§’ï¼‰
       addBead(img.dataset.single, -Math.PI/2);
     });
   });
 }
 // DnD: ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸ãƒ‰ãƒ­ãƒƒãƒ— â†’ è§’åº¦ã‚¹ãƒŠãƒƒãƒ—é…ç½®
 svg.addEventListener("dragover", e=>e.preventDefault());
 svg.addEventListener("drop", e=>{
   e.preventDefault();
   const raw = e.dataTransfer.getData("photo");
   if(!raw) return;
   const p = JSON.parse(raw);
   const rect = svg.getBoundingClientRect();
   const x = e.clientX - rect.left;
   const y = e.clientY - rect.top;
   const angle = angleAtPoint(x,y);
   addBead(p.singleUrl, angle);
 });
 // === ãƒœã‚¿ãƒ³ãƒ»ãƒŠãƒ“ ===
 addPartBtn.addEventListener("click", ()=> location.href="admin.html");
 partsBtn.addEventListener("click", async ()=>{ partsPanel.classList.add("open"); await loadPhotos(); });
 closePanel.addEventListener("click", ()=> partsPanel.classList.remove("open"));
 document.getElementById("saveBtn").addEventListener("click", ()=>{
   alert("ä¿å­˜ã¯ç«¯æœ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ãŠé¡˜ã„ã—ã¾ã™ï¼ˆPNGæ›¸ãå‡ºã—ã‚‚è¿½åŠ å¯èƒ½ï¼‰");
 });
</script>
</body>
</html>
