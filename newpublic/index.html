<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>+ILLuSio</title>
<style>
 :root{
   --panel-bg: rgba(255,255,255,.98);
   --wire:#bfbfbf;
 }
 body{
   margin:0; font-family:"Hiragino Sans",sans-serif; background:#f7f7f7;
   height:100vh; display:flex; flex-direction:column; justify-content:space-between; text-align:center;
 }
 header{ position:relative; padding:10px 0 0; }
 .logo{ font-weight:700; font-size:2rem; margin:.5rem 0 0; }
 .add-part{
   position:absolute; right:10px; top:10px; background:#fff; color:#333;
   border:1px solid #aaa; border-radius:8px; padding:6px 10px; cursor:pointer;
 }
 .main-area{ flex:1; display:flex; align-items:center; justify-content:center; }
 .necklace-area{ position:relative; }
 svg{ display:block; }
 .bottom-buttons{ display:flex; gap:10px; justify-content:center; padding:14px 0; }
 button{ background:#333; color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer; }
 button:hover{ background:#555; }
 /* ä¸‹ã‹ã‚‰å‡ºã‚‹ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ */
 .parts-panel{
   position:fixed; left:0; right:0; bottom:-60%;
   background:var(--panel-bg); border-top:2px solid #ccc; border-radius:16px 16px 0 0;
   box-shadow:0 -2px 12px rgba(0,0,0,.15); transition:bottom .35s ease; padding:18px; z-index:10;
   max-height:60%; overflow:auto; text-align:center;
 }
 .parts-panel.open{ bottom:0; }
 .parts-grid{
   display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); margin-top:10px;
 }
 .parts-grid img{
   width:100px; height:100px; object-fit:contain; background:#fff; border:1px solid #aaa; border-radius:10px; cursor:grab;
   transition:transform .15s;
 }
 .parts-grid img:active{ transform:scale(.95); }
 .close-panel{ position:absolute; right:18px; top:10px; font-size:26px; cursor:pointer; }
 /* ã‚¬ãƒ©ã‚¹é¢¨ æ“ä½œãƒãƒ¼ï¼ˆå³ä¸‹å›ºå®šï¼‰ */
 .edit-bar{
   position:fixed; right:20px; bottom:20px; display:none; flex-direction:column; gap:12px;
   padding:16px; border-radius:16px; z-index:100;
   background:rgba(255,255,255,.15); backdrop-filter:blur(10px);
   border:1px solid rgba(255,255,255,.35); box-shadow:0 4px 16px rgba(0,0,0,.3);
   animation:fadeIn .25s ease;
 }
 .edit-bar.show{ display:flex; }
 @keyframes fadeIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
 .edit-row{ display:flex; gap:8px; justify-content:center; }
 .edit-bar button{
   width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,.08);
   border:1px solid rgba(255,255,255,.4); color:#fff; font-size:18px; font-weight:700; cursor:pointer;
   transition:transform .15s, background .15s, box-shadow .15s;
 }
 .edit-bar button:hover{
   background:rgba(255,255,255,.3); transform:scale(1.08); box-shadow:0 0 10px rgba(255,255,255,.45);
 }
 .move-grid{
   display:grid; grid-template-columns:44px 44px 44px; gap:6px; justify-content:center; align-items:center;
 }
</style>
</head>
<body>
<header>
<h1 class="logo">+ILLuSio</h1>
<button id="addPartBtn" class="add-part">ï¼‹ãƒ‘ãƒ¼ãƒ„è¿½åŠ </button>
</header>
<main class="main-area">
<div class="necklace-area" id="necklaceArea">
<svg id="canvas" width="340" height="340">
<!-- ãƒ¯ã‚¤ãƒ¤ãƒ¼ï¼ˆå††ï¼‰ -->
<circle id="wire" cx="170" cy="170" r="140" stroke="var(--wire)" stroke-width="2" fill="none"/>
</svg>
</div>
</main>
<footer class="bottom-buttons">
<button id="saveBtn">ğŸ’ ä¿å­˜</button>
<button id="partsBtn">ğŸ’  ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</button>
</footer>
<!-- ãƒ‘ãƒ¼ãƒ„ä¸€è¦§ -->
<div id="partsPanel" class="parts-panel">
<span id="closePanel" class="close-panel">&times;</span>
<h2>ãƒ‘ãƒ¼ãƒ„ä¸€è¦§</h2>
<div id="partsGrid" class="parts-grid"></div>
</div>
<!-- æ“ä½œãƒãƒ¼ -->
<div id="editBar" class="edit-bar">
<div class="edit-row">
<button id="rotateL" title="å·¦å›è»¢">â†º</button>
<button id="rotateR" title="å³å›è»¢">â†»</button>
</div>
<div class="edit-row">
<button id="bigger"  title="æ‹¡å¤§">ï¼‹</button>
<button id="smaller" title="ç¸®å°">ï¼</button>
</div>
<div class="move-grid">
<div></div><button id="moveUp"   title="ä¸Šã¸">â†‘</button><div></div>
<button id="moveLeft" title="å·¦ã¸">â†</button><div></div><button id="moveRight" title="å³ã¸">â†’</button>
<div></div><button id="moveDown" title="ä¸‹ã¸">â†“</button><div></div>
</div>
<button id="delete" title="å‰Šé™¤">ğŸ—‘</button>
</div>
<script>
 // === åŸºæœ¬å‚ç…§ ===
 const addPartBtn = document.getElementById("addPartBtn");
 const partsBtn   = document.getElementById("partsBtn");
 const partsPanel = document.getElementById("partsPanel");
 const closePanel = document.getElementById("closePanel");
 const partsGrid  = document.getElementById("partsGrid");
 const editBar    = document.getElementById("editBar");
 const svg        = document.getElementById("canvas");
 const wire       = document.getElementById("wire");
 // æ“ä½œãƒœã‚¿ãƒ³
 const btnRotL = document.getElementById("rotateL");
 const btnRotR = document.getElementById("rotateR");
 const btnBig  = document.getElementById("bigger");
 const btnSmall= document.getElementById("smaller");
 const btnUp   = document.getElementById("moveUp");
 const btnDown = document.getElementById("moveDown");
 const btnLeft = document.getElementById("moveLeft");
 const btnRight= document.getElementById("moveRight");
 const btnDel  = document.getElementById("delete");
 // ç”»é¢è¨­å®š
 const CX = parseFloat(wire.getAttribute("cx")); // 170
 const CY = parseFloat(wire.getAttribute("cy")); // 170
 const R  = parseFloat(wire.getAttribute("r"));  // 140
 // çŠ¶æ…‹ç®¡ç†
 let beads = [];   // [{el, angle(rad)}]
 let selected = null;
 let rotationDeg = 0;
 let lastActionAt = 0;
 // é€£æ‰“å¯¾ç­–ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
 function canAct(interval=120){
   const now = Date.now();
   if(now - lastActionAt < interval) return false;
   lastActionAt = now;
   return true;
 }
 // è§’åº¦â‡”åº§æ¨™
 function posFromAngle(angle, w=35, h=35){
   const cx = CX + R * Math.cos(angle);
   const cy = CY + R * Math.sin(angle);
   return { x: cx - w/2, y: cy - h/2 };
 }
 function centerOf(el){
   const x = parseFloat(el.getAttribute("x"));
   const y = parseFloat(el.getAttribute("y"));
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   return { cx: x + w/2, cy: y + h/2, w, h, x, y };
 }
 function angleAtPoint(x, y){
   return Math.atan2(y - CY, x - CX);
 }
 function normalize(a){
   while(a <= -Math.PI) a += 2*Math.PI;
   while(a >   Math.PI) a -= 2*Math.PI;
   return a;
 }
 // é¸æŠ & æ“ä½œãƒãƒ¼è¡¨ç¤º
 function selectBead(el){
   selected = beads.find(b => b.el === el) || null;
   if(!selected){ editBar.classList.remove("show"); return; }
   rotationDeg = parseFloat(el.dataset.rotate || "0");
   editBar.classList.add("show");
 }
 svg.addEventListener("pointerdown", e=>{
   if(e.target.tagName.toLowerCase() !== "image"){
     selected = null;
     editBar.classList.remove("show");
   }
 });
 // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: beads[] ã® angle ã«åŸºã¥ã„ã¦å…¨ã¦é…ç½®
 function layoutAll(anchorIndex=null){
   const n = beads.length;
   if(n === 0) return;
   if(n === 1){
     const b = beads[0]; const el = b.el;
     const w = parseFloat(el.getAttribute("width"))||35;
     const h = parseFloat(el.getAttribute("height"))||35;
     const p = posFromAngle(b.angle, w, h);
     el.setAttribute("x", p.x); el.setAttribute("y", p.y);
     // å›è»¢ã®ä¸­å¿ƒæ›´æ–°
     const cx = p.x + w/2, cy = p.y + h/2;
     const rot = parseFloat(el.dataset.rotate || "0");
     el.setAttribute("transform", `rotate(${rot}, ${cx}, ${cy})`);
     return;
   }
   // ç­‰é–“éš”æ•´åˆ—ï¼ˆanchorIndexã®ãƒ“ãƒ¼ã‚ºãŒç¾åœ¨ã®è§’åº¦ã‚’ä¿ã¤ï¼‰
   const baseIdx = (anchorIndex===null)? 0 : anchorIndex;
   const baseAngle = beads[baseIdx].angle;
   const step = 2*Math.PI / n;
   for(let i=0;i<n;i++){
     const idx = i;
     const ang = normalize(baseAngle + (idx - baseIdx)*step);
     beads[idx].angle = ang;
     const el = beads[idx].el;
     const w = parseFloat(el.getAttribute("width"))||35;
     const h = parseFloat(el.getAttribute("height"))||35;
     const p = posFromAngle(ang, w, h);
     el.setAttribute("x", p.x); el.setAttribute("y", p.y);
     // å›è»¢ä¸­å¿ƒã¯å¸¸ã«è‡ªèº«ã®ä¸­å¿ƒ
     const cx = p.x + w/2, cy = p.y + h/2;
     const rot = parseFloat(el.dataset.rotate || "0");
     el.setAttribute("transform", `rotate(${rot}, ${cx}, ${cy})`);
   }
 }
 // beadsé…åˆ—ã‚’è§’åº¦é †ã«å›è»¢ã•ã›ã¦æŒ¿å…¥
 function insertAtAngle(movedBead, targetAngle){
   // æ—¢å­˜ã‹ã‚‰ä¸€æ—¦é™¤å¤–
   beads = beads.filter(b => b !== movedBead);
   // è§’åº¦ã§æŒ¿å…¥ä½ç½®ã‚’æ±ºå®šï¼ˆæœ€ã‚‚è¿‘ã„ä½ç½®ã®ç›´å¾Œï¼‰
   if(beads.length === 0){
     movedBead.angle = normalize(targetAngle);
     beads.push(movedBead);
     layoutAll(0);
     return;
   }
   // è§’åº¦æ˜‡é †ã«ä¸¦ã‚“ã§ã„ã‚‹ã¨ã¿ãªã—ã¦ã€æŒ¿å…¥ç‚¹ã‚’æ¢ã™
   let idx = 0;
   let minDiff = Infinity;
   beads.forEach((b, i)=>{
     const diff = Math.abs(normalize(targetAngle - b.angle));
     if(diff < minDiff){ minDiff = diff; idx = i; }
   });
   // è¿‘ã„ã‚‚ã®ã®ã€Œæ¬¡ã€ã«æŒ¿å…¥
   const insertIndex = (idx + 1);
   beads.splice(insertIndex, 0, movedBead);
   movedBead.angle = normalize(targetAngle);
   // ã‚¢ãƒ³ã‚«ãƒ¼ã¯æŒ¿å…¥ã—ãŸ movedBead ã«ã—ã¦ç­‰é–“éš”å†é…ç½®
   layoutAll(insertIndex);
 }
 // ç”»åƒè¿½åŠ ï¼ˆä¸€è¦§ã‹ã‚‰ã®ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
 function addBead(singleUrl, angle){
   const el = document.createElementNS("http://www.w3.org/2000/svg","image");
   el.setAttributeNS(null,"href", singleUrl);
   el.setAttributeNS(null,"width", 35);
   el.setAttributeNS(null,"height",35);
   el.dataset.rotate = "0";
   svg.appendChild(el);
   const bead = { el, angle: normalize(angle) };
   insertAtAngle(bead, angle);
   // é¸æŠï¼†ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼â†’é›¢ã—ãŸã‚‰å†æ•´åˆ—ï¼‰
   let dragging = false, offsetX=0, offsetY=0;
   el.addEventListener("pointerdown", (e)=>{
     selectBead(el);
     dragging = true;
     const rect = svg.getBoundingClientRect();
     const c = centerOf(el);
     offsetX = e.clientX - rect.left - c.x;
     offsetY = e.clientY - rect.top  - c.y;
     el.setPointerCapture(e.pointerId);
   });
   el.addEventListener("pointermove", (e)=>{
     if(!dragging) return;
     const rect = svg.getBoundingClientRect();
     const x = e.clientX - rect.left - offsetX;
     const y = e.clientY - rect.top  - offsetY;
     el.setAttribute("x", x);
     el.setAttribute("y", y);
     // å›è»¢ä¸­å¿ƒã‚‚è¿½éš
     const w = parseFloat(el.getAttribute("width"));
     const h = parseFloat(el.getAttribute("height"));
     const cx = x + w/2, cy = y + h/2;
     const rot = parseFloat(el.dataset.rotate || "0");
     el.setAttribute("transform", `rotate(${rot}, ${cx}, ${cy})`);
   });
   el.addEventListener("pointerup", (e)=>{
     dragging = false;
     el.releasePointerCapture(e.pointerId);
     // æŒ‡ã‚’é›¢ã—ãŸä½ç½®ã®è§’åº¦ã«ã‚¹ãƒŠãƒƒãƒ—ã—ã¦å†æ•´åˆ—
     const c = centerOf(el);
     const a = angleAtPoint(c.cx, c.cy);
     insertAtAngle(bead, a);
     selectBead(el);
   });
 }
 // === ä¸€è¦§ã®èª­ã¿è¾¼ã¿ ===
 async function loadParts(){
   partsGrid.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";
   try{
     const res = await fetch("/photos");
     const photos = await res.json();
     if(!Array.isArray(photos) || photos.length===0){
       partsGrid.innerHTML = "<p>ãƒ‘ãƒ¼ãƒ„ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>"; return;
     }
     partsGrid.innerHTML = "";
     photos.forEach(p=>{
       const img = document.createElement("img");
       img.src = p.listUrl;
       img.alt = p.color || "";
       img.draggable = true;
       img.addEventListener("dragstart", e=>{
         e.dataTransfer.setData("photo", JSON.stringify(p));
       });
       partsGrid.appendChild(img);
     });
   }catch(err){
     partsGrid.innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}</p>`;
   }
 }
 // === ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ ï¼ˆå¸ç€ï¼‰ ===
 svg.addEventListener("dragover", e=>e.preventDefault());
 svg.addEventListener("drop", e=>{
   e.preventDefault();
   const raw = e.dataTransfer.getData("photo");
   if(!raw) return;
   const p = JSON.parse(raw);
   const rect = svg.getBoundingClientRect();
   const x = e.clientX - rect.left;
   const y = e.clientY - rect.top;
   const angle = angleAtPoint(x, y);
   addBead(p.singleUrl, angle);
 });
 // === UI ===
 addPartBtn.addEventListener("click", ()=> location.href="admin.html");
 partsBtn.addEventListener("click", async ()=>{ partsPanel.classList.add("open"); await loadParts(); });
 closePanel.addEventListener("click", ()=> partsPanel.classList.remove("open"));
 document.getElementById("saveBtn").addEventListener("click", ()=>{
   alert("ä¿å­˜ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ãŠé¡˜ã„ã—ã¾ã™ï¼ˆPNGæ›¸ãå‡ºã—ã¯å¾Œã§è¿½åŠ å¯èƒ½ï¼‰");
 });
 // === æ“ä½œï¼šå›è»¢ï¼ˆä¸­å¿ƒåŸºæº– 15Â°ï¼‰ ===
 function applyCenterRotate(el, deg){
   el.dataset.rotate = String(deg);
   const c = centerOf(el);
   el.setAttribute("transform", `rotate(${deg}, ${c.cx}, ${c.cy})`);
 }
 btnRotL.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg -= 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 btnRotR.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   rotationDeg += 15;
   applyCenterRotate(selected.el, rotationDeg);
 });
 // === æ“ä½œï¼šæ‹¡å¤§ç¸®å°ï¼ˆå¼·ã‚ãƒ»é€£æ‰“ã‚¬ãƒ¼ãƒ‰ï¼‰ ===
 function resizeSelected(scale){
   const el = selected.el;
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   const nw = Math.min(Math.max(w*scale, 16), 220);
   const nh = Math.min(Math.max(h*scale, 16), 220);
   // ä¸­å¿ƒã‚’ä¿ã£ã¦æ‹¡å¤§ç¸®å°
   const c = centerOf(el);
   el.setAttribute("x", c.cx - nw/2);
   el.setAttribute("y", c.cy - nh/2);
   el.setAttribute("width", nw);
   el.setAttribute("height", nh);
   // å›è»¢ä¸­å¿ƒã‚‚æ›´æ–°
   applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
 }
 btnBig.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   resizeSelected(1.5); // 1ã‚¿ãƒƒãƒ—ã§ç´„1.5å€
 });
 btnSmall.addEventListener("click", ()=>{
   if(!selected || !canAct()) return;
   resizeSelected(1/1.5); // ç´„0.67å€
 });
 // === æ“ä½œï¼šç§»å‹•ï¼ˆâ†‘â†“â†â†’ ï¼ å††å‘¨ã«æ²¿ã£ã¦ç§»å‹•ï¼ãƒ¯ã‚¤ãƒ¤ãƒ¼å¤–ã«ã¯å‡ºãªã„ï¼‰ ===
 const stepDeg = 6; // 1æŠ¼ã—ã§6Â°
 function moveAlong(stepSign){
   // stepSign: +1 (CW=æ™‚è¨ˆå›ã‚Š=å³/ä¸‹), -1 (CCW=åæ™‚è¨ˆå›ã‚Š=å·¦/ä¸Š)
   const bead = selected;
   if(!bead) return;
   bead.angle = normalize(bead.angle + stepSign * stepDeg * Math.PI/180);
   // è‡ªåˆ†ã ã‘ç§»å‹•ï¼ˆä»–ã¯ç¶­æŒï¼‰
   const el = bead.el;
   const w = parseFloat(el.getAttribute("width"));
   const h = parseFloat(el.getAttribute("height"));
   const p = posFromAngle(bead.angle, w, h);
   el.setAttribute("x", p.x);
   el.setAttribute("y", p.y);
   // å›è»¢ä¸­å¿ƒæ›´æ–°
   applyCenterRotate(el, parseFloat(el.dataset.rotate||"0"));
 }
 btnLeft .addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(-1); });
 btnUp   .addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(-1); });
 btnRight.addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(+1); });
 btnDown .addEventListener("click", ()=>{ if(!selected || !canAct()) return; moveAlong(+1); });
 // === å‰Šé™¤ ===
 btnDel.addEventListener("click", ()=>{
   if(!selected) return;
   selected.el.remove();
   beads = beads.filter(b => b !== selected);
   selected = null;
   editBar.classList.remove("show");
   layoutAll(0);
 });
 // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆä¸€è¦§å¾Œã§ã‚‚ï¼‰
 svg.addEventListener("click", e=>{
   if(e.target.tagName.toLowerCase()==="image"){
     selectBead(e.target);
   }
 });
</script>
</body>
</html>
